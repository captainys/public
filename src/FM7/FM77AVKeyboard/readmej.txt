FM77AV/AV40赤外線ワイヤレスキーボードエミュレータ(要IRToy)

by 山川機長 (http://www.ysflight.com)





はじめに

このプログラムは、FM77AVおよびFM77AV40のワイヤレスキーボードをWindows上でエミュレートして、実機でのタイピングを可能にするものです。必要なデバイスとして、IRToy (http://dangerousprototypes.com/docs/USB_Infrared_Toy)が必要です。なお、Amazon.comでも買えます(https://www.amazon.com/dp/B01M03RQEQ)。残念ながら日本では販売している代理店は存在しない模様です。

手元にあるのがFM77AV2とFM77AV40だけなので、試すことはできませんが、FM77AV20でも多分使えると思います。が、動かなかったとしても、ごめんなさい。とりあえず、こちらのテスト機では両方とも完璧に動作していて、このプログラムを使ってXanadu Sceinario 2をクリアしてエンディングを見ることができました。自作チートデータでしたが。

なお、FM77AV40EX以降の機種では赤外線センサーが無いため使えません。

また、この手のプログラムではありがちなオートストップ機能(テンキーを放したときに5を押したことにする)や、キーを押した瞬間からリピートが効き続ける連射機能、ボタン一発でFM77AVキーボードエンコーダの隠しメッセージを出す機能などあります。

ついでに、アメリカに住んでるもので、日本語キーボードが無いので日本語キーボードのバインディングが正しくできてるか確認する方法は一切ないのですが、タイプしたキーではなく文字を元に対応するキーコードを発生させる機能 (TRANSLATIONモード)があります。例えば、うちのキーボードはUS101ですが、普通にタイプすればその通りFM77AV上に字が出ます。また、ローマ字タイプするとカナに変換してタイプしてくれる機能(RKANAモード)なども搭載してみました。30年前、アドベンチャーゲームでカナタイプができなくて苦しんだ恨みを(まだソフト持ってたら)今こそ晴らすことができます。FM77AV用ゲームをするときなどは、DIRECTモードがいいと思います。



使い方

まず、IRToyをUSB経由で接続します。ここで、IRToyのLEDが消灯していることを確認してください。

IRToyを接続したら、FM77AV Keyboard Emulatorを起動します。インストーラを作るのがむなしくなってきたので、そんなもの無いので、実行ファイルを直接実行してください。なお、ウイルスとセキュリティとか心配な人は、ソースコードがついているので、一通り読んだ上でそれでも不安なら使わないでください。

うまくいくと、FM77AV Keyboard EmulatorはCOMポートをスキャンしてIRToyを探します。

あとは、FM77AVまたはFM77AV40本体の赤外線ポートの近くにIRToyの赤外線LEDを置いて、FM77AV Keyboard Emulatorにキーをタイプすると、コードが本体に送られます。





謝辞

このプログラムを開発するにあたって、Apolloさん(http://www.retropc.net/apollo/)にかなりの助言をいただきました。とくに、FM77AVキーボードの赤外線信号を計測して100usパルスらしいという情報をいただいたのは助かりました。また、クラシックPC研究会(http://classicpc.org/index.html)の小林さんには、有線接続の場合のパルス情報とキーリリースコードの計算方法の助言をいただきました。このおかげで、キーリリースコードを送らないまま接続が途切れたときFM77AVが抗議して「ピッ」とビープを鳴らすのを止めることができました。また、ですくまさん(http://d.hatena.ne.jp/deskuma/20110425/1303694255)のキーボードのパルス計測データを参考にさせていただきました。貴重なデータを公開していただいたことを感謝しています。





更新情報
2018/02/14
- IRToy ファームウェアバージョン1.2でも動作確認(今までは2.2でテストしていた)
- リピートタイマーを初期化してなかったもんだから、起動する時刻によってまったくキーコードが送られない場合がある問題を修正。この問題がたまたま久しぶりにAV40でテストしたときに起こったもんだから、AVで動いてAV40で動かなくなったかと一瞬焦ったけど単純なエラーだった。

2018/02/04
- とにかく速くメインループ回そうと思ってたら、コンソールモードだったらうまく動くのに、コンソール無しモードにしたら途端にキーの取りこぼしが増えてなんでだろう、ひょっとしてこれでもスピード不足？と、思っていたら、逆で、メインループがCPUを100%食ってしまってCOMポートのドライバがデータ送信する時間が不足してたらしい。コンソールモードだと、送信確認の文字列表示中の隙間を縫って送信してたのかな？ループごとに1ms sleepを入れたらウィンドウモードでもぜんぜん落ちなくなった。

2018/01/31
- ZXCキーを左、中、右スペースに対応させる機能。Directモードで使用可能。
- 矢印キーをテンキーの2,4,6,8、または1,2,3,4,6,7,8,9に対応させる機能。Directモードで使用可能。

2018/01/26
- Translationモードでコロンとセミコロンを忘れていたことに気づいたので追加。

2018/01/23  バージョン1


次の更新の予定: 
(1) テキストファイルを指定するとその通りタイプしてくれる機能を追加する予定。これをさらにすすめると、アドベンチャーゲームが勝手に進んでいく機能とかいうのもぜひ実装したい。
(2) ゲームパッドをキーボードに対応させて、当時のジョイスティック非対応のFM-7のゲームを実機でゲームパッドで遊べるようにする。




ソースコードについて

BSDライセンスです。自由にしてください。でも、何があっても僕は一切責任を負いませんのでご了承ください。





